<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="../Css/bootstrap.min.css" rel="stylesheet" type="text/css" />
  <link href="../Css/font-awesome.min.css" rel="stylesheet" type="text/css" />
  <link href="../Css/tsbs.css" rel="stylesheet" type="text/css" />
  <!--[if IE]><link href="../Css/tsbs-ie.css" rel="stylesheet" type="text/css" /><![endif]-->
  <link href="../Css/frame.css" rel="stylesheet" type="text/css" />

  <script src="../Js/jquery-latest.min.js" type="text/javascript"></script>

  <script src="../Js/bootstrap.min.js" type="text/javascript"></script>

  <style type="text/css">
    .user-info { padding: 10px 0; }
  </style>
  <script language="javascript" type="text/javascript">

  

    $(document).ready(function () {
      $('.action-refresh').click(function (e) { e.preventDefault(); window.location = window.location; });

      $('#inputOrg').typeahead({
        items: 5,
        minLength: 2,
        updater: function (item) {
          $('#inputUser').parents('.control-group').show();
          orgTypeAhead.selectedID = orgTypeAhead.map[item].id;
          return item;
        },
        source: getOrganizations
      });

      var orgTypeAhead = { map: {}, selectedID: -1, ajax: null };
      function getOrganizations(query, process) {
        if (orgTypeAhead.ajax) { orgTypeAhead.ajax._executor.abort(); }

        orgTypeAhead.ajax = top.Ts.Services.Organizations.AdminGetOrganizations(query, function (result) {
          if (result == null) process(null);
          var orgs = [];
          $.each(result, function (i, org) {
            orgTypeAhead.map[org.label] = org;
            orgs.push(org.label);
          });
          process(orgs);
        });
      }
      $('#inputUser').parents('.control-group').hide();
      $('#inputUser').typeahead({
        items: 5,
        minLength: 2,
        updater: function (item) {
          userTypeAhead.selectedID = userTypeAhead.map[item].id;
          showUserInfo(userTypeAhead.selectedID);
          return item;
        },
        source: getUsers
      });

      var userTypeAhead = { map: {}, selectedID: -1, ajax: null };
      function getUsers(query, process) {
        if (userTypeAhead.ajax) { userTypeAhead.ajax._executor.abort(); }

        userTypeAhead.ajax = top.Ts.Services.Users.AdminQueryUsers(orgTypeAhead.selectedID, query, function (result) {
          if (result == null) process(null);
          var items = [];
          $.each(result, function (i, item) {
            userTypeAhead.map[item.label] = item;
            items.push(item.label);
          });
          process(items);
        });
      }

      $('.user-box').hide();

      function showUserInfo(userID) {
        top.Ts.Services.Users.AdminGetUser(userID, function (user) {
          var el = $('.user-info').empty().data('o', user);
          if (user.EnforceSingleSession == false)
            $('.action-toggle-session').addClass('btn-warning').html('<i class="icon-shield"></i> Enforce Single Session');
          else
            $('.action-toggle-session').removeClass('btn-warning').html('<i class="icon-shield"></i> Unenforce Single Session');
          $('.user-box').show().find('.user-name').text(user.FirstName + ' ' + user.LastName);
          appendData(el, user);
        });
      }

      function appendData(element, data) {
        var table = $('<table>').appendTo(element);
        function addRow(k, v) {
          var row = $('<tr>').appendTo(table);
          $('<td>').html(k + ':').appendTo(row);
          $('<td>').html(v == null ? 'NULL' : v + '').appendTo(row);
        }
        for (prop in data) { addRow(prop, data[prop]); }
      }

      $('.action-toggle-session').click(function (e) {
        e.preventDefault();
        var user = $('.user-info').data('o');
        top.Ts.Services.Users.SetSingleSessionEnforcement(userTypeAhead.selectedID, !user.EnforceSingleSession, function () {
          showUserInfo(userTypeAhead.selectedID);
        });

      });

      $('.action-refresh-user').click(function (e) {
        e.preventDefault();
        showUserInfo(userTypeAhead.selectedID);
      });

    });  
  </script>

</head>
<body>
  <div class="frame-content">
    <div class="container-fluid">
      <div class="row-fluid">
        <div class="span12">
          <div class="box">
            <div class="box-header">
              <h3><i class="icon-group"></i>Users Utility</h3>
              <div class="box-actions">
                <a class="btn btn-link action-refresh" href="#"><i class="icon-refresh"></i></a>
              </div>
            </div>
            <div class="box-content">
              <form class="form-horizontal">
              <div class="control-group">
                <label class="control-label" for="inputOrg">Company</label>
                <div class="controls">
                  <input class="span4" type="text" id="inputOrg" placeholder="Company" autocomplete="off" data-provide="typeahead">
                </div>
              </div>
              <div class="control-group">
                <label class="control-label" for="inputUser">User</label>
                <div class="controls">
                  <input class="span4" type="text" id="inputUser" placeholder="User">
                </div>
              </div>


              </form>
            </div>
          </div>
          <div class="box user-box">
            <div class="box-header">
              <h3><i class="icon-user"></i> <span class="user-name"></span></h3>
              <div class="box-actions">
                <a class="btn btn-link action-refresh-user" href="#"><i class="icon-refresh"></i></a>
              </div>
            </div>
            <div class="box-content">
              
              <div class="user-info"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
