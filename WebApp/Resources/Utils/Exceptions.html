<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title></title>
  <link href="../Css/frame.css" rel="stylesheet" type="text/css" />
  <link href="../Css/jquery-ui-latest.custom.css" rel="stylesheet" type="text/css" />
  <link href="../Css/jquery-ui-enhanced.css" rel="stylesheet" type="text/css" />
  <link href="../Css/ts.ui.css" rel="stylesheet" type="text/css" />
  <!--[if IE 7]><link href="vcr/1_9_0/Css/ts.ui.ie7.css" rel="stylesheet" type="text/css" /><![endif]-->
  <!--[if IE 8]><link href="vcr/1_9_0/Css/ts.ui.ie8.css" rel="stylesheet" type="text/css" /><![endif]-->
  <style type="text/css">
    .utils-content { border: none; overflow: auto; height: 100%; }
    .utils-content-wrapper { padding: 2em 2em; }
    #divHeader { padding: 1em 1em;}
    #divTopExceptions td { padding: .25em 1em; }
    #divTopExceptions tr { cursor:pointer; }
  </style>

  <script src="/frontend/library/jquery-latest.min.js" type="text/javascript"></script>
  <script src="/frontend/library/jquery-ui-latest.custom.min.js" type="text/javascript"></script>
  <script src="/frontend/library/jquery.layout.min.js" type="text/javascript"></script>
  <script language="javascript" type="text/javascript">

    $(document).ready(function () {
      $('button').button();

      this._layout = $('.ts-layout-container').layout({
        resizeNestedLayout: true,
        defaults: {
          spacing_open: 5,
          closable: false
        },
        center: { paneSelector: ".ts-layout-content",
          triggerEventsOnLoad: false
        },
        north: { paneSelector: ".ts-toolbar", size: 31, spacing_open: 0, resizable: false },
        south: { spacing_open: 5, paneSelector: ".preview", size: 225, closable: false }
      });

      var layout = this._layout;


      $('.ts-loading').hide().next().show();

      $('#btnRefresh').click(function (e) {
        e.preventDefault();
        window.location = window.location;
      });

      $('#btnOpen').click(function (e) {
        e.preventDefault();
        loadException($('#textException').val());
      });

      $('#btnClear').click(function (e) {
        e.preventDefault();
        top.Ts.Services.System.ClearExceptionLogs(false, function () { loadTopExceptions(); });
      });

      $('#btnClearApi').click(function (e) {
        e.preventDefault();
        top.Ts.Services.System.ClearExceptionLogs(true, function () { loadTopExceptions(); });
      });
      

      $('#btnThrow').click(function (e) {
        e.preventDefault();
        top.Ts.Services.System.CreateNewException(function () { loadTopExceptions(); });
      });

      function loadException(id) {
        top.Ts.Services.System.GetException(id, function (exception) {
          $('.preview').html('');
          var table = $('<table>').appendTo($('.preview'));
          for (prop in exception) {
            var row = $('<tr>').appendTo(table);
            $('<td>').text(prop + ':').appendTo(row);
            $('<td>').html(exception[prop] == null ? '' : exception[prop] + '').appendTo(row);
          }
        });
      }

      function loadTopExceptions() {
        top.Ts.Services.System.GetExceptionLogCount(function (count) {
          $('#divCount').html('Total Count: ' + count);
        });

        top.Ts.Services.System.GetTopExceptions(function (exceptions) {
          $('#divTopExceptions').html('');
          var table = $('<table>').attr('cellpadding', '10').appendTo('#divTopExceptions');
          for (var i = 0; i < exceptions.length; i++) {
            var id = exceptions[i].ExceptionLogID;
            var row = $('<tr>').appendTo(table).data('id', id).click(function (e) {
              e.preventDefault();
              loadException($(this).data('id'));

            });
            try {
              $('<td>').text(exceptions[i].ExceptionLogID).appendTo(row);
              $('<td>').text(exceptions[i].URL).appendTo(row);
              $('<td>').text(exceptions[i].FirstName + ' ' + exceptions[i].LastName).appendTo(row);
              $('<td>').text(exceptions[i].Name).appendTo(row);
              $('<td>').html(exceptions[i].DateCreated + '').appendTo(row);
            } catch (e) {
              $('<td>').text(e.message).appendTo(row);
            }
          }

        });
      }
      loadTopExceptions();
    });  
  </script>

</head>
<body>
  <div class="ts-layout-container  ui-widget">
    <div class="ts-layout-content">
      <div class="ts-loading">
      </div>
      <div class="utils-content ui-widget ui-widget-content">
        <div class="utils-content-wrapper">
          <div id="divCount"></div>
          <div id="divTopExceptions"></div>
        </div>
      </div>
      <div class="utils-content ui-widget ui-widget-content ui-helper-hidden">
        <div class="utils-content-wrapper">
          Exception ID:
          <input class="text ui-corner-all ui-widget-content" type="text" id="textException"
            style="width: 250px;" />
          <button id="btnOpen">Open</button>
          <div id="divException">
          </div>
        </div>
      </div>
    </div>
    <div class="ts-toolbar ui-widget-header">
      <button id="btnRefresh">Refresh</button>
      <button id="btnClear">Clear Exceptions</button>
      <button id="btnClearApi">Clear CRM and API Exceptions</button>
      <button id="btnThrow">Throw Exception</button>
    </div>
    <div class="preview utils-content ui-widget ui-widget-content"></div>
  </div>

</body>
</html>
